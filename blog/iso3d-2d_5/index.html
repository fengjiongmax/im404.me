<!DOCTYPE html>
<html lang="en-us">
    <head>
        
        
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KPT6VZPK03"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-KPT6VZPK03', { 'anonymize_ip': false });
}
</script>



<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<title>
Isometric 3 D in 2 D Environment #5 More Order and Move Sync - fengjiongmax
</title>



        
        <meta property="og:title" content="Isometric 3D in 2D Environment #5 More order and move sync - fengjiongmax" />
<meta property="og:type" content="website" />
<meta property="og:description" content=""/>
<meta property="og:url" content="https://im404.me/blog/iso3d-2d_5/"/>
<meta property="og:site_name" content="fengjiongmax"/>




<meta property="og:image" content="https://im404.me/home/avatar.png"/>




        
<link rel="shortcut icon" href="/img/fav.ico">


        





<link rel="stylesheet" href="/css/main.min.424f46f9828895ed67f0fdbfacf94dac470c2905ee36e8eca3c726047cf38d04.css" integrity="sha256-Qk9G&#43;YKIle1n8P2/rPlNrEcMKQXuNujso8cmBHzzjQQ=" crossorigin="anonymous" media="screen">





        
        
        
        
    </head>
    <body>
        <section id="top" class="section">
            
            <div class="container hero ">
                

<h1 class="bold-title is-1">Blog</h1>


            </div>
            
            <div class="section ">
                

<div class="container">
    <hr>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        
        <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false" >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
        <div class="navbar-menu " id="navMenu">
            
            
            
            
            <a class="navbar-item" href="/">main</a>
            

            
            

            
                
            

            
                
            

            
            
            
            <a class="navbar-item" href="/#about">About</a>
            
            
            
            
            
                
                
                
                
                  <a class="navbar-item" href="https://im404.me/blog/">
                  
                  Back to Blog
                  
                  </a>
                
                
            
            
            
            
            
                
                
                
                
                  <a class="navbar-item" href="https://im404.me/projects/">
                  
                  
                  Projects
                  
                  
                  </a>
                
                
            
            
            
            

            
            
            

            

            
            <a class="navbar-item" href="https://im404.me/index.xml"><i class="fas fa-rss"></i></a>
            
            
        </div>
    </nav>
    <hr>
</div>




                
<div class="container">
    <h2 class="title is-1 top-pad strong-post-title">
        <a href="https://im404.me/blog/iso3d-2d_5/">Isometric 3D in 2D Environment #5 More order and move sync</a>
    </h2>
    
    <div class="post-data">
        Apr 21, 2021
        
         | 
        6 minutes read
        
    </div>
    
    <div class="blog-share">
        Share this:
        
        <a class="twitter-share-button"
            href="https://twitter.com/intent/tweet?text=Isometric%203D%20in%202D%20Environment%20%235%20More%20order%20and%20move%20sync%20https%3a%2f%2fim404.me%2fblog%2fiso3d-2d_5%2f"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
            <i class="fab fa-twitter"></i>
            <span class="hidden">Twitter</span>
        </a>
        
        
        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fim404.me%2fblog%2fiso3d-2d_5%2f"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
            <i class="fab fa-facebook-f"></i>
            <span class="hidden">Facebook</span>
        </a>
        
        
        <a class="icon-pinterest"
            href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fim404.me%2fblog%2fiso3d-2d_5%2f&amp;description=Isometric%203D%20in%202D%20Environment%20%235%20More%20order%20and%20move%20sync"
            onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
            <i class="fab fa-pinterest-p"></i>
            <span class="hidden">Pinterest</span>
        </a>
        
    </div>
    
    
    
    
    <p>
        Categories:
        
        <a href="/categories/ladder_box">
            Ladder_Box</a>
        
    </p>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <p>
        Series:
        
        <a href="/series/3d_iso_in_2d">
            3D_iso_in_2D</a>
        
    </p>
    
    
    
    
    <p>
        Tags:
        
        <a href="/tags/godot_engine">
            Godot_Engine</a>,
        
        <a href="/tags/tutorial">
            Tutorial</a>,
        
        <a href="/tags/gdscript">
            GDScript</a>,
        
        <a href="/tags/ladder_box">
            Ladder_Box</a>
        
    </p>
    
    
    
    
</div>

<div class="container markdown top-pad">
    <p>This is part 5 of the 2d/3d(game/engine) conversion used in my puzzle game: Ladder Box, which is available on Steam:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/-PINYXwhEkc" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p><a href="https://store.steampowered.com/app/1444390/Ladder_Box/"><img src="/img/steam.png" alt="get it on steam"></a></p>
<p>You can find all the textures, scripts in this GitHub repo: <a href="https://github.com/fengjiongmax/3D_iso_in_2D">https://github.com/fengjiongmax/3D_iso_in_2D</a></p>
<p>Godot 3.2.x is used in this project, you can check the commits for what&rsquo;s new in each part of this series.</p>

<h1 id="the-problem" class="anchor-link"><a href="#the-problem">The problem</a></h1>
<p>If you set the board like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span>new_movable(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>new_movable(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>new_movable(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>new_movable(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p>run the game and hit ‘Z’, you’ll see:
<img src="/img/iso3D-2D-5th/unordered_move.gif" alt=""></p>
<p>the one V3(0,0,0) will stay still, but this is not what we want, so let’s figure out how this happened and how to solve this.</p>
<p>When we creating movables, we will add them to the group “movables”, and when we issue a command to make them move, we call the command function in their states one by one, the order of calling the command function is the order we create them, that’s :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span>new_movable(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>new_movable(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>new_movable(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>new_movable(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p>This means when the <code>V3(0,0,0)</code> receives the command, both <code>V3(0,0,1)</code> and <code>V3(1,0,0)</code> have not run their <code>set_next_target</code> function in move state yet, which means they haven’t set their game_pos to their correspond <code>target_game_pos</code>, which makes the <code>V3(0,0,0)</code> think there’s a block in front of it and a block right above it, so it stays.</p>
<p>Then this is a similar problem that we solved in the second part of this series, but this will be a bit tricky to solve.</p>

<h1 id="solution" class="anchor-link"><a href="#solution">Solution</a></h1>
<p>We need to call the command in a custom order so that we can issue commands and update them correctly, to do that, let’s create a custom script to write codes for that:</p>
<p><img src="/img/iso3D-2D-5th/compare_script.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span>class_name Compare
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this is key &#34;S&#34; direction</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Vector3.FORWARD = Vector3( 0, 0, -1 )</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> forward_compare(item1:BlockBase,item2:BlockBase):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>z <span style="color:#f92672">&gt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>z:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>z <span style="color:#f92672">&lt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>z:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> true
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> y_compare(item1,item2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this is key &#34;Z&#34; direction</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Vector3.BACK = Vector3( 0, 0, 1 )</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> back_compare(item1:BlockBase,item2:BlockBase):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>z <span style="color:#f92672">&gt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>z:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> true
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>z <span style="color:#f92672">&lt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>z:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> y_compare(item1,item2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this is key &#34;X&#34; direction</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Vector3.RIGHT = Vector3( 1, 0, 0 )</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> right_compare(item1:BlockBase,item2:BlockBase):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>x <span style="color:#f92672">&gt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>x:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> true
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>x <span style="color:#f92672">&lt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>x:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> y_compare(item1,item2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># this is key &#34;A&#34; direction</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Vector3.LEFT = Vector3( -1, 0, 0 )</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> left_compare(item1:BlockBase,item2:BlockBase):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>x <span style="color:#f92672">&gt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>x:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>x <span style="color:#f92672">&lt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>x:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> true
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> y_compare(item1,item2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">func</span> y_compare(item1:BlockBase,item2:BlockBase):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>y <span style="color:#f92672">&gt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>y:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">elif</span> item1<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>y <span style="color:#f92672">&lt;</span> item2<span style="color:#f92672">.</span>game_pos<span style="color:#f92672">.</span>y:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> true
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e"># compare by z-index : z-index = x+y+z</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> GridUtils<span style="color:#f92672">.</span>calc_xyz(item1<span style="color:#f92672">.</span>game_pos) <span style="color:#f92672">&gt;</span> GridUtils<span style="color:#f92672">.</span>calc_xyz(item2<span style="color:#f92672">.</span>game_pos):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> true
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false
</span></span></code></pre></div><p>We can call the corresponding function according to the key pressed, and we can calculate the correct order by using the <code>sort_custom</code> function in Array:
Sorts the array using a custom method. The arguments are an object that holds the method and the name of such method. The custom method receives two arguments (a pair of elements from the array) and must return either true or false.
Note: you cannot randomize the return value as the heapsort algorithm expects a deterministic result. Doing so will result in unexpected behavior.
Add a function in grid.gd:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> sort_by_direction(direction:<span style="color:#a6e22e">Vector3</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">Array</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _sorted <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	_sorted <span style="color:#f92672">=</span> get_tree()<span style="color:#f92672">.</span>get_nodes_in_group(<span style="color:#e6db74">&#34;movable&#34;</span>)<span style="color:#f92672">.</span>duplicate()
</span></span><span style="display:flex;"><span>	match direction:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Vector3</span><span style="color:#f92672">.</span>FORWARD:
</span></span><span style="display:flex;"><span>			_sorted<span style="color:#f92672">.</span>sort_custom(Compare,<span style="color:#e6db74">&#34;forward_compare&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Vector3</span><span style="color:#f92672">.</span>BACK:
</span></span><span style="display:flex;"><span>			_sorted<span style="color:#f92672">.</span>sort_custom(Compare,<span style="color:#e6db74">&#34;back_compare&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Vector3</span><span style="color:#f92672">.</span>LEFT:
</span></span><span style="display:flex;"><span>			_sorted<span style="color:#f92672">.</span>sort_custom(Compare,<span style="color:#e6db74">&#34;left_compare&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Vector3</span><span style="color:#f92672">.</span>RIGHT:
</span></span><span style="display:flex;"><span>			_sorted<span style="color:#f92672">.</span>sort_custom(Compare,<span style="color:#e6db74">&#34;right_compare&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> _sorted
</span></span></code></pre></div><p>And in main.gd :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> sorted <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> send_command(command:<span style="color:#a6e22e">Vector3</span>) <span style="color:#f92672">-&gt;</span> void:
</span></span><span style="display:flex;"><span>	sorted <span style="color:#f92672">=</span> Grid<span style="color:#f92672">.</span>sort_by_direction(command)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> sorted:
</span></span><span style="display:flex;"><span>		i<span style="color:#f92672">.</span>receive_command({<span style="color:#e6db74">&#34;direction&#34;</span>:command})
</span></span><span style="display:flex;"><span>	set_physics_process(true)
</span></span></code></pre></div><p>also in the update function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> _physics_process(delta):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> _m <span style="color:#f92672">in</span> sorted:
</span></span><span style="display:flex;"><span>		_m<span style="color:#f92672">.</span>_update(delta)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>Run the scene:</p>
<p><img src="/img/iso3D-2D-5th/ordered_move.gif" alt=""></p>
<p>The <code>V3(0,0,0)</code> moves at the beginning. But the V(0,1,0) will fall in the middle of the road, let’s see if we can fix that.</p>

<h1 id="move-sync" class="anchor-link"><a href="#move-sync">Move sync</a></h1>
<p>As we discussed in the 3rd part of this series, we know that the movable moves in a vector 2 direction but they are in a grid-based board, so after each update, they may not end up in the exact engine location, so they may not reach the <code>target_engine_pos</code> the same time, that causes the fall.</p>
<p>Then we need to sync the movements of the movable, we’re gonna use signal to do that, add these to movable.gd:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">signal</span> block_reach_target
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> reach_target():
</span></span><span style="display:flex;"><span>	emit_signal(<span style="color:#e6db74">&#34;block_reach_target&#34;</span>)
</span></span></code></pre></div><p>and in the main.gd, we will call the send command to tell the movable when one of them reaches the target:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> block_reach_target():
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> sorted:
</span></span><span style="display:flex;"><span>		i<span style="color:#f92672">.</span>_command({<span style="color:#e6db74">&#34;reach_target&#34;</span>:true})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>and connect the <code>movable.block_rach_target</code> signal to <code>movable_into_idle</code> function when creating it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> new_movable(x,y,z):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _m <span style="color:#f92672">=</span> movable<span style="color:#f92672">.</span>instance()
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">$</span>movable<span style="color:#f92672">.</span>add_child(_m)
</span></span><span style="display:flex;"><span>	_m<span style="color:#f92672">.</span>initial_game_pos(x,y,z)
</span></span><span style="display:flex;"><span>	_m<span style="color:#f92672">.</span>connect(<span style="color:#e6db74">&#34;block_reach_target&#34;</span>,self,<span style="color:#e6db74">&#34;block_reach_target&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>And call reach_target function every time the block reaches the target, we need to modify move, jump, fall states.
<code>move.gd</code>, <code>replace _update</code>, <code>add _command</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> _update(_delta:<span style="color:#a6e22e">float</span>) <span style="color:#f92672">-&gt;</span> void:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _after_move <span style="color:#f92672">=</span> movable<span style="color:#f92672">.</span>position <span style="color:#f92672">+</span> engine_direction <span style="color:#f92672">*</span> _delta <span style="color:#f92672">*</span> movable<span style="color:#f92672">.</span>MOVESPEED
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _reach_target <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span>is_betweenv(movable<span style="color:#f92672">.</span>position,_after_move,target_engine_pos)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>_reach_target:
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> _after_move
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> target_engine_pos
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>z_index <span style="color:#f92672">=</span> target_z
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>reach_target()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> _command(_msg:<span style="color:#a6e22e">Dictionary</span><span style="color:#f92672">=</span>{}) <span style="color:#f92672">-&gt;</span> void:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>_msg<span style="color:#f92672">.</span>keys()<span style="color:#f92672">.</span>has(<span style="color:#e6db74">&#34;reach_target&#34;</span>):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	movable<span style="color:#f92672">.</span>engine_fit_game_pos()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _self_down_axie <span style="color:#f92672">=</span> movable<span style="color:#f92672">.</span>game_pos <span style="color:#f92672">+</span> <span style="color:#a6e22e">Vector3</span><span style="color:#f92672">.</span>DOWN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> Grid<span style="color:#f92672">.</span>coordinate_within_rangev(_self_down_axie) <span style="color:#f92672">&amp;&amp;</span> Grid<span style="color:#f92672">.</span>get_game_axisv(_self_down_axie) <span style="color:#f92672">==</span> null:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">var</span> _down_moved <span style="color:#f92672">=</span> Grid<span style="color:#f92672">.</span>get_game_axisv(_self_down_axie <span style="color:#f92672">+</span> direction)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>(_down_moved is Movable <span style="color:#f92672">&amp;&amp;</span> _down_moved<span style="color:#f92672">.</span>get_node(<span style="color:#e6db74">&#34;state_machine&#34;</span>)<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;move&#34;</span>):
</span></span><span style="display:flex;"><span>			_state_machine<span style="color:#f92672">.</span>switch_state(<span style="color:#e6db74">&#34;fall&#34;</span>,{<span style="color:#e6db74">&#34;direction&#34;</span>:direction})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	set_next_target()
</span></span></code></pre></div><p>and same for <code>jump.gd</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> _update(_delta:<span style="color:#a6e22e">float</span>) <span style="color:#f92672">-&gt;</span> void:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _after_move <span style="color:#f92672">=</span> movable<span style="color:#f92672">.</span>position <span style="color:#f92672">+</span> engine_direction <span style="color:#f92672">*</span> _delta <span style="color:#f92672">*</span> movable<span style="color:#f92672">.</span>MOVESPEED
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _reach_target <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span>is_betweenv(movable<span style="color:#f92672">.</span>position,_after_move,target_engine_pos)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>_reach_target:
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> _after_move
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> target_engine_pos
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>reach_target()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> _command(_msg:<span style="color:#a6e22e">Dictionary</span><span style="color:#f92672">=</span>{}) <span style="color:#f92672">-&gt;</span> void:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>_msg<span style="color:#f92672">.</span>keys()<span style="color:#f92672">.</span>has(<span style="color:#e6db74">&#34;reach_target&#34;</span>):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	movable<span style="color:#f92672">.</span>engine_fit_game_pos()
</span></span><span style="display:flex;"><span>		_state_machine<span style="color:#f92672">.</span>switch_state(<span style="color:#e6db74">&#34;move&#34;</span>,{<span style="color:#e6db74">&#34;direction&#34;</span>:move_direction})
</span></span></code></pre></div><p><code>fall.gd</code> also:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> _update(_delta:<span style="color:#a6e22e">float</span>) <span style="color:#f92672">-&gt;</span> void:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _after_move <span style="color:#f92672">=</span> movable<span style="color:#f92672">.</span>position <span style="color:#f92672">+</span> engine_direction <span style="color:#f92672">*</span> _delta <span style="color:#f92672">*</span> movable<span style="color:#f92672">.</span>MOVESPEED
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _reach_target <span style="color:#f92672">=</span> Math<span style="color:#f92672">.</span>is_betweenv(movable<span style="color:#f92672">.</span>position,_after_move,target_engine_pos)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>_reach_target:
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> _after_move
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>position <span style="color:#f92672">=</span> target_engine_pos
</span></span><span style="display:flex;"><span>		movable<span style="color:#f92672">.</span>reach_target()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> _command(_msg:<span style="color:#a6e22e">Dictionary</span><span style="color:#f92672">=</span>{}) <span style="color:#f92672">-&gt;</span> void:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>_msg<span style="color:#f92672">.</span>keys()<span style="color:#f92672">.</span>has(<span style="color:#e6db74">&#34;reach_target&#34;</span>):
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	movable<span style="color:#f92672">.</span>engine_fit_game_pos()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _self_down_axie <span style="color:#f92672">=</span> movable<span style="color:#f92672">.</span>game_pos <span style="color:#f92672">+</span> <span style="color:#a6e22e">Vector3</span><span style="color:#f92672">.</span>DOWN
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> _down_moved <span style="color:#f92672">=</span> Grid<span style="color:#f92672">.</span>get_game_axisv(_self_down_axie <span style="color:#f92672">+</span> move_direction)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> _down_moved is Movable <span style="color:#f92672">&amp;&amp;</span> _down_moved<span style="color:#f92672">.</span>get_node(<span style="color:#e6db74">&#34;state_machine&#34;</span>)<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;move&#34;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> move_direction <span style="color:#f92672">==</span> <span style="color:#a6e22e">Vector3</span><span style="color:#f92672">.</span>ZERO:
</span></span><span style="display:flex;"><span>			_state_machine<span style="color:#f92672">.</span>switch_state(<span style="color:#e6db74">&#34;idle&#34;</span>,{})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>			_state_machine<span style="color:#f92672">.</span>switch_state(<span style="color:#e6db74">&#34;move&#34;</span>,{<span style="color:#e6db74">&#34;direction&#34;</span>:move_direction})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	set_next_target()
</span></span></code></pre></div><p>And run the scene, you will see:
<img src="/img/iso3D-2D-5th/shaky_movable.gif" alt=""></p>
<p>they move as expected, but you may see some of them wobble a little bit, that’s because when a movable emits signal <code>block_reach_target</code> all the movable get set to their <code>target_engine_pos</code>, but in the <code>_physics_process</code> function of main.gd, it may be in the middle of an update, so some movables will move one update cycle faster than others.</p>
<p>this can be fixed by this, use a <code>block_reached_target</code> variable, and set it to true when <code>block_reach_target</code> gets called, and <code>_physics_update</code> will update movables accordingly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript" data-lang="gdscript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> block_reached_target :<span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> _physics_process(delta):
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> _m <span style="color:#f92672">in</span> sorted:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> block_reached_target:
</span></span><span style="display:flex;"><span>			block_reached_target <span style="color:#f92672">=</span> false
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		_m<span style="color:#f92672">.</span>_update(delta)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> block_reach_target():
</span></span><span style="display:flex;"><span>	block_reached_target <span style="color:#f92672">=</span> true
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> sorted:
</span></span><span style="display:flex;"><span>		i<span style="color:#f92672">.</span>_command({<span style="color:#e6db74">&#34;reach_target&#34;</span>:true})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p><img src="/img/iso3D-2D-5th/stable_movable.gif" alt="">
and no more shaky movables.</p>
<p>That’s it for this article, next article will be the finale of this series, we will be testing a lot and adjusting the behaviors of the movable to make the movement feels natural.
You can find all the textures, scripts in this GitHub repo: <a href="https://github.com/fengjiongmax/3D_iso_in_2D">https://github.com/fengjiongmax/3D_iso_in_2D</a></p>

</div>


    <div class="container disqus">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "fjmax" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>



                
                <div class="container">
    <hr>
</div>
<div class="container has-text-centered top-pad">
    <a href="#top">
        <i class="fa fa-arrow-up"></i>
    </a>
</div>

<div class="container">
    <hr>
</div>

                <div class="section" id="footer">
    <div class="container has-text-centered">
    
        <span class="footer-text">
            <a href="https://github.com/victoriadrake/hugo-theme-introduction/"><strong>Introduction</strong></a> theme for <a href="http://gohugo.io/">Hugo</a>. Made with <a href="https://victoria.dev"><!-- raw HTML omitted --><!-- raw HTML omitted --> and <!-- raw HTML omitted --><!-- raw HTML omitted --></a> by open source contributors.
        </span>
    
    </div>
</div>

                
            </div>
        </section>
        
        


<script src="https://im404.me/js/bundle.5c23c0437f001a469ca373a465a6f7487203d18e10cdff76d86a60af66d5ee28.js" integrity="sha256-XCPAQ38AGkaco3OkZab3SHID0Y4Qzf922Gpgr2bV7ig="></script>




        
        
        
        
    </body>
</html>
